<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>src/davinci-eight/utils/windowAnimationRunner.ts - davinci-eight</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="icon" href="../assets/favicon.ico">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
                <h1><img src="../../assets/logo.png" title="davinci-eight"></h1>
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 2.56.0</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
                    <h2 class="off-left">APIs</h2>
                    <div id="api-tabview" class="tabview">
                        <ul class="tabs">
                            <li><a href="#api-classes">Classes</a></li>
                            <li><a href="#api-modules">Modules</a></li>
                        </ul>
                
                        <div id="api-tabview-filter">
                            <input type="search" id="api-filter" placeholder="Type to filter APIs">
                        </div>
                
                        <div id="api-tabview-panel">
                            <ul id="api-classes" class="apis classes">
                                <li><a href="../classes/AmbientLight.html">AmbientLight</a></li>
                                <li><a href="../classes/ArrowBuilder.html">ArrowBuilder</a></li>
                                <li><a href="../classes/ArrowOptions.html">ArrowOptions</a></li>
                                <li><a href="../classes/AttribMetaInfo.html">AttribMetaInfo</a></li>
                                <li><a href="../classes/AttribMetaInfos.html">AttribMetaInfos</a></li>
                                <li><a href="../classes/AttribProvider.html">AttribProvider</a></li>
                                <li><a href="../classes/BarnGeometry.html">BarnGeometry</a></li>
                                <li><a href="../classes/BoxBuilder.html">BoxBuilder</a></li>
                                <li><a href="../classes/BoxMesh.html">BoxMesh</a></li>
                                <li><a href="../classes/Cartesian1.html">Cartesian1</a></li>
                                <li><a href="../classes/Cartesian2.html">Cartesian2</a></li>
                                <li><a href="../classes/Cartesian3.html">Cartesian3</a></li>
                                <li><a href="../classes/Color.html">Color</a></li>
                                <li><a href="../classes/Color
                WARNING: In many object-oriented designs, types representing values are completely immutable.
                In a graphics library where data changes rapidly and garbage collection might become an issue,
                it is common to use reference types, such as in this design. This mutability can lead to
                difficult bugs because it is hard to reason about where a color may have changed..html">Color
                WARNING: In many object-oriented designs, types representing values are completely immutable.
                In a graphics library where data changes rapidly and garbage collection might become an issue,
                it is common to use reference types, such as in this design. This mutability can lead to
                difficult bugs because it is hard to reason about where a color may have changed.</a></li>
                                <li><a href="../classes/CuboidMesh.html">CuboidMesh</a></li>
                                <li><a href="../classes/CylinderArgs.html">CylinderArgs</a></li>
                                <li><a href="../classes/DefaultUniformProvider.html">DefaultUniformProvider</a></li>
                                <li><a href="../classes/DirectionalLight.html">DirectionalLight</a></li>
                                <li><a href="../classes/Drawable.html">Drawable</a></li>
                                <li><a href="../classes/DrawMode.html">DrawMode</a></li>
                                <li><a href="../classes/ElementArray.html">ElementArray</a></li>
                                <li><a href="../classes/EllipsoidMesh.html">EllipsoidMesh</a></li>
                                <li><a href="../classes/Face3.html">Face3</a></li>
                                <li><a href="../classes/frustum.html">frustum</a></li>
                                <li><a href="../classes/Frustum.html">Frustum</a></li>
                                <li><a href="../classes/Geometry.html">Geometry</a></li>
                                <li><a href="../classes/GeometryAdapter.html">GeometryAdapter</a></li>
                                <li><a href="../classes/KleinBottleGeometry.html">KleinBottleGeometry</a></li>
                                <li><a href="../classes/Line3.html">Line3</a></li>
                                <li><a href="../classes/LocalModel.html">LocalModel</a></li>
                                <li><a href="../classes/Matrix4.html">Matrix4</a></li>
                                <li><a href="../classes/Model.html">Model</a></li>
                                <li><a href="../classes/Mutable.html">Mutable</a></li>
                                <li><a href="../classes/Node.html">Node</a></li>
                                <li><a href="../classes/Perspective.html">Perspective</a></li>
                                <li><a href="../classes/perspective.html">perspective</a></li>
                                <li><a href="../classes/Point3.html">Point3</a></li>
                                <li><a href="../classes/PointLight.html">PointLight</a></li>
                                <li><a href="../classes/Renderer.html">Renderer</a></li>
                                <li><a href="../classes/RenderingContextUser.html">RenderingContextUser</a></li>
                                <li><a href="../classes/ShaderAttribLocation.html">ShaderAttribLocation</a></li>
                                <li><a href="../classes/ShaderAttribLocation..html">ShaderAttribLocation.</a></li>
                                <li><a href="../classes/ShaderProgram.html">ShaderProgram</a></li>
                                <li><a href="../classes/ShaderUniformLocation.html">ShaderUniformLocation</a></li>
                                <li><a href="../classes/ShaderVariableDecl.html">ShaderVariableDecl</a></li>
                                <li><a href="../classes/Spinor3.html">Spinor3</a></li>
                                <li><a href="../classes/Symbolic.html">Symbolic</a></li>
                                <li><a href="../classes/TreeModel.html">TreeModel</a></li>
                                <li><a href="../classes/UniformColor.html">UniformColor</a></li>
                                <li><a href="../classes/UniformFloat.html">UniformFloat</a></li>
                                <li><a href="../classes/UniformMetaInfo.html">UniformMetaInfo</a></li>
                                <li><a href="../classes/UniformMetaInfos.html">UniformMetaInfos</a></li>
                                <li><a href="../classes/UniformProvider.html">UniformProvider</a></li>
                                <li><a href="../classes/UniformSpinor3.html">UniformSpinor3</a></li>
                                <li><a href="../classes/UniformVariable.html">UniformVariable</a></li>
                                <li><a href="../classes/UniformVector3.html">UniformVector3</a></li>
                                <li><a href="../classes/Vector2.html">Vector2</a></li>
                                <li><a href="../classes/Vector3.html">Vector3</a></li>
                                <li><a href="../classes/View.html">View</a></li>
                                <li><a href="../classes/view.html">view</a></li>
                                <li><a href="../classes/WindowAnimationRunner.html">WindowAnimationRunner</a></li>
                            </ul>
                
                            <ul id="api-modules" class="apis modules">
                                <li><a href="../modules/EIGHT.html">EIGHT</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
                    Show:
                    <label for="api-show-inherited">
                        <input type="checkbox" id="api-show-inherited" checked>
                        Inherited
                    </label>
            
                    <label for="api-show-protected">
                        <input type="checkbox" id="api-show-protected">
                        Protected
                    </label>
            
                    <label for="api-show-private">
                        <input type="checkbox" id="api-show-private">
                        Private
                    </label>
                    <label for="api-show-deprecated">
                        <input type="checkbox" id="api-show-deprecated">
                        Deprecated
                    </label>
            
                </div>
            
            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
<h1 class="file-heading">File: src/davinci-eight/utils/windowAnimationRunner.ts</h1>

<div class="file">
    <pre class="code prettyprint linenums">
import WindowAnimationRunner = require(&#x27;../utils/WindowAnimationRunner&#x27;);
import expectArg = require(&#x27;../checks/expectArg&#x27;);

function defaultSetUp(): void {
}

function defaultTearDown(animateException): void {
  if (animateException) {
    let message = &quot;Exception raised during animate function: &quot; + animateException;
    console.warn(message);
  }
}

function defaultTerminate(time: number): boolean {
  // Never ending, because whenever asked we say nee.
  return false;
}

/**
 * Creates an object implementing a stopwatch API that makes callbacks to user-supplied functions.
 * @param animate The &#x60;animate&#x60; function is called for each animation frame.
 * @param options.setUp The &#x60;setUp&#x60; function is called synchronously each time the start() method is called.
 * @param options.tearDown The &#x60;tearDown&#x60; function is called asynchronously each time the animation is stopped.
 * @param options.terminate The &#x60;terminate&#x60; function is called to determine whether the animation should stop.
 * @param options.window {Window} The window in which the animation will run. Defaults to the global window. 
 */
var animation = function(
    animate: (time: number) =&gt; void,
    options?: {
      setUp?: () =&gt; void;
      tearDown?: (animateException) =&gt; void;
      terminate?: (time: number) =&gt; boolean;
      window?: Window }): WindowAnimationRunner {

    // TODO: Use enum when TypeScript compiler version is appropriate.
    var STATE_INITIAL = 1;
    var STATE_RUNNING = 2;
    var STATE_PAUSED = 3;

    options = options || {};

    let $window: Window = expectArg(&#x27;options.window&#x27;, options.window || window).toNotBeNull().value;
    let setUp: () =&gt; void = expectArg(&#x27;options.setUp&#x27;, options.setUp || defaultSetUp).value;
    let tearDown: (animateException) =&gt; void = expectArg(&#x27;options.tearDown&#x27;, options.tearDown || defaultTearDown).value;
    let terminate: (time: number) =&gt; boolean = expectArg(&#x27;options.terminate&#x27;, options.terminate || defaultTerminate).toNotBeNull().value;

    var stopSignal = false;       // 27 is Esc
//  var pauseKeyPressed = false;  // 19
//  var enterKeyPressed = false;  // 13
    var startTime: number;
    var elapsed: number = 0;
    var MILLIS_PER_SECOND = 1000;
    var requestID: number = null;
    var animateException: any;
    var state = STATE_INITIAL;

    let frameRequestCallback: FrameRequestCallback = function(timestamp: number) {
      if (startTime) {
        elapsed = elapsed + timestamp - startTime;
      }
      startTime = timestamp;

      if (stopSignal || terminate(elapsed / MILLIS_PER_SECOND)) {
        // Clear the stopSignal.
        stopSignal = false;

        $window.cancelAnimationFrame(requestID);
        if (publicAPI.isRunning) {
          state = STATE_PAUSED;
          startTime = void 0;
        }
        else {
          // TODO: Can we recover?
          console.error(&quot;stopSignal received while not running.&quot;);
        }
        $window.document.removeEventListener(&#x27;keydown&#x27;, onDocumentKeyDown, false);
        try {
          tearDown(animateException);
        }
        catch (e) {
          console.warn(&quot;Exception raised during tearDown function: &quot; + e);
        }
      }
      else {
        requestID = $window.requestAnimationFrame(frameRequestCallback);
        // If an exception happens, cache it to be reported later and simulate a stopSignal.
        try {
          animate(elapsed / MILLIS_PER_SECOND);
        }
        catch (e) {
          animateException = e;
          stopSignal = true;
        }
      }
    };

    var onDocumentKeyDown = function(event: KeyboardEvent) {
      // TODO: It would be nice for all key responses to be soft-defined.
      // In other words, a mapping of event (keyCode) to action (start, stop, reset)
      if (event.keyCode === 27) {
        stopSignal = true;
        event.preventDefault();
      }
      /*
      else if (event.keyCode === 19) {
        pauseKeyPressed = true;
        event.preventDefault();
      }
      else if (event.keyCode === 13) {
        enterKeyPressed = true;
        event.preventDefault();
      }
      */
    };

    // The public API is a classic stopwatch.
    // The states are INITIAL, RUNNING, PAUSED.
    var publicAPI: WindowAnimationRunner = {
      start() {
        if (!publicAPI.isRunning) {
          setUp();
          $window.document.addEventListener(&#x27;keydown&#x27;, onDocumentKeyDown, false);
          state = STATE_RUNNING;
          requestID = $window.requestAnimationFrame(frameRequestCallback);
        }
        else {
          throw new Error(&quot;The &#x60;start&#x60; method may only be called when not running.&quot;);
        }
      },
      stop() {
        if (publicAPI.isRunning) {
          stopSignal = true;
        }
        else {
          throw new Error(&quot;The &#x60;stop&#x60; method may only be called when running.&quot;);
        }
      },
      reset: function() {
        if (publicAPI.isPaused) {
          startTime = void 0;
          elapsed = 0;
          state = STATE_INITIAL;
        }
        else {
          throw new Error(&quot;The &#x60;reset&#x60; method may only be called when paused.&quot;);
        }
      },
      get time(): number {
        return elapsed / MILLIS_PER_SECOND;
      },
      lap: function() {
        if (publicAPI.isRunning) {
          // No change of state. We just record the current lap time and save it to some kind of history.
        }
        else {
          throw new Error(&quot;The &#x60;lap&#x60; method may only be called when running.&quot;);
        }
      },
      get isRunning(): boolean {
        return state === STATE_RUNNING;
      },
      get isPaused(): boolean {
        return state === STATE_PAUSED;
      }
    };

    return publicAPI;
};

export = animation;

    </pre>
</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
