<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>src/davinci-eight/objects/drawableModel.ts - davinci-eight</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="icon" href="../assets/favicon.ico">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
                <h1><img src="../../assets/logo.png" title="davinci-eight"></h1>
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 2.36.0</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
                    <h2 class="off-left">APIs</h2>
                    <div id="api-tabview" class="tabview">
                        <ul class="tabs">
                            <li><a href="#api-classes">Classes</a></li>
                            <li><a href="#api-modules">Modules</a></li>
                        </ul>
                
                        <div id="api-tabview-filter">
                            <input type="search" id="api-filter" placeholder="Type to filter APIs">
                        </div>
                
                        <div id="api-tabview-panel">
                            <ul id="api-classes" class="apis classes">
                                <li><a href="../classes/AmbientLight.html">AmbientLight</a></li>
                                <li><a href="../classes/AttributeMetaInfo.html">AttributeMetaInfo</a></li>
                                <li><a href="../classes/AttributeMetaInfos.html">AttributeMetaInfos</a></li>
                                <li><a href="../classes/AttributeProvider.html">AttributeProvider</a></li>
                                <li><a href="../classes/BoxMesh.html">BoxMesh</a></li>
                                <li><a href="../classes/Cartesian3.html">Cartesian3</a></li>
                                <li><a href="../classes/Color.html">Color</a></li>
                                <li><a href="../classes/Color
                WARNING: In many object-oriented designs, types representing values are completely immutable.
                In a graphics library where data changes rapidly and garbage collection might become an issue,
                it is common to use reference types, such as in this design. This mutability can lead to
                difficult bugs because it is hard to reason about where a color may have changed..html">Color
                WARNING: In many object-oriented designs, types representing values are completely immutable.
                In a graphics library where data changes rapidly and garbage collection might become an issue,
                it is common to use reference types, such as in this design. This mutability can lead to
                difficult bugs because it is hard to reason about where a color may have changed.</a></li>
                                <li><a href="../classes/CuboidMesh.html">CuboidMesh</a></li>
                                <li><a href="../classes/DefaultUniformProvider.html">DefaultUniformProvider</a></li>
                                <li><a href="../classes/DirectionalLight.html">DirectionalLight</a></li>
                                <li><a href="../classes/Drawable.html">Drawable</a></li>
                                <li><a href="../classes/DrawMode.html">DrawMode</a></li>
                                <li><a href="../classes/ElementArray.html">ElementArray</a></li>
                                <li><a href="../classes/EllipsoidMesh.html">EllipsoidMesh</a></li>
                                <li><a href="../classes/Face3.html">Face3</a></li>
                                <li><a href="../classes/Frustum.html">Frustum</a></li>
                                <li><a href="../classes/frustum.html">frustum</a></li>
                                <li><a href="../classes/Geometry.html">Geometry</a></li>
                                <li><a href="../classes/GeometryAdapter.html">GeometryAdapter</a></li>
                                <li><a href="../classes/KleinBottleGeometry.html">KleinBottleGeometry</a></li>
                                <li><a href="../classes/Line3.html">Line3</a></li>
                                <li><a href="../classes/LinearPerspectiveCamera.html">LinearPerspectiveCamera</a></li>
                                <li><a href="../classes/Matrix4
                
                The correspondence between the elements property index and the matrix entries is...
                
                 0  4  8 12
                 1  5  9 13
                 2  6 10 14
                 3  7 11 15.html">Matrix4
                
                The correspondence between the elements property index and the matrix entries is...
                
                 0  4  8 12
                 1  5  9 13
                 2  6 10 14
                 3  7 11 15</a></li>
                                <li><a href="../classes/Model.html">Model</a></li>
                                <li><a href="../classes/ModelMatrixUniformProvider.html">ModelMatrixUniformProvider</a></li>
                                <li><a href="../classes/Mutable.html">Mutable</a></li>
                                <li><a href="../classes/Node3D.html">Node3D</a></li>
                                <li><a href="../classes/perspective.html">perspective</a></li>
                                <li><a href="../classes/Point3.html">Point3</a></li>
                                <li><a href="../classes/PointLight.html">PointLight</a></li>
                                <li><a href="../classes/RenderingContextUser.html">RenderingContextUser</a></li>
                                <li><a href="../classes/ShaderAttributeLocation.html">ShaderAttributeLocation</a></li>
                                <li><a href="../classes/ShaderAttributeLocation..html">ShaderAttributeLocation.</a></li>
                                <li><a href="../classes/ShaderProgram.html">ShaderProgram</a></li>
                                <li><a href="../classes/ShaderUniformLocation.html">ShaderUniformLocation</a></li>
                                <li><a href="../classes/ShaderVariableDecl.html">ShaderVariableDecl</a></li>
                                <li><a href="../classes/Spinor3.html">Spinor3</a></li>
                                <li><a href="../classes/UniformColor.html">UniformColor</a></li>
                                <li><a href="../classes/UniformFloat.html">UniformFloat</a></li>
                                <li><a href="../classes/UniformMetaInfo.html">UniformMetaInfo</a></li>
                                <li><a href="../classes/UniformMetaInfos.html">UniformMetaInfos</a></li>
                                <li><a href="../classes/UniformProvider.html">UniformProvider</a></li>
                                <li><a href="../classes/UniformSpinor3.html">UniformSpinor3</a></li>
                                <li><a href="../classes/UniformVariable.html">UniformVariable</a></li>
                                <li><a href="../classes/UniformVector3.html">UniformVector3</a></li>
                                <li><a href="../classes/Vector3.html">Vector3</a></li>
                                <li><a href="../classes/view.html">view</a></li>
                                <li><a href="../classes/View.html">View</a></li>
                                <li><a href="../classes/Viewport.html">Viewport</a></li>
                                <li><a href="../classes/WindowAnimationRunner.html">WindowAnimationRunner</a></li>
                            </ul>
                
                            <ul id="api-modules" class="apis modules">
                                <li><a href="../modules/EIGHT.html">EIGHT</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
                    Show:
                    <label for="api-show-inherited">
                        <input type="checkbox" id="api-show-inherited" checked>
                        Inherited
                    </label>
            
                    <label for="api-show-protected">
                        <input type="checkbox" id="api-show-protected">
                        Protected
                    </label>
            
                    <label for="api-show-private">
                        <input type="checkbox" id="api-show-private">
                        Private
                    </label>
                    <label for="api-show-deprecated">
                        <input type="checkbox" id="api-show-deprecated">
                        Deprecated
                    </label>
            
                </div>
            
            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
<h1 class="file-heading">File: src/davinci-eight/objects/drawableModel.ts</h1>

<div class="file">
    <pre class="code prettyprint linenums">
import AttributeMetaInfo = require(&#x27;../core/AttributeMetaInfo&#x27;); 
import AttributeMetaInfos = require(&#x27;../core/AttributeMetaInfos&#x27;); 
import ShaderProgram = require(&#x27;../programs/ShaderProgram&#x27;);
import ShaderVariableDecl = require(&#x27;../core/ShaderVariableDecl&#x27;);
import ShaderAttributeLocation = require(&#x27;../core/ShaderAttributeLocation&#x27;);
import ShaderUniformLocation = require(&#x27;../core/ShaderUniformLocation&#x27;);
import ElementArray = require(&#x27;../core/ElementArray&#x27;);
import ChainedUniformProvider = require(&#x27;../uniforms/ChainedUniformProvider&#x27;);
import DrawableModel = require(&#x27;../objects/DrawableModel&#x27;);
import AttributeProvider = require(&#x27;../core/AttributeProvider&#x27;);
import UniformProvider = require(&#x27;../core/UniformProvider&#x27;);
import UniformMetaInfo = require(&#x27;../core/UniformMetaInfo&#x27;);
import UniformMetaInfos = require(&#x27;../core/UniformMetaInfos&#x27;);

var drawableModel = function&lt;MESH extends AttributeProvider, SHADERS extends ShaderProgram, MODEL extends UniformProvider&gt;(
  mesh: MESH,
  shaders: SHADERS,
  model: MODEL): DrawableModel&lt;MESH, SHADERS, MODEL&gt; {
  /**
   * Find an attribute by its code name rather than its semantic role (which is the key in AttributeMetaInfos)
   */
  function findAttributeMetaInfoByVariableName(name: string, attributes: AttributeMetaInfos): AttributeMetaInfo {
    for (var key in attributes) {
      let attribute = attributes[key];
      if (attribute.name === name) {
        return attribute;
      }
    }
  }
  /**
   * Constructs a ShaderAttributeLocation from a declaration.
   */
  function shaderAttributeLocationFromDecl(declaration: ShaderVariableDecl): ShaderAttributeLocation {
    // Looking up the attribute meta info gives us some early warning if the mesh is deficient.
    let attribute: AttributeMetaInfo = findAttributeMetaInfoByVariableName(declaration.name, mesh.getAttributeMetaInfos());
    if (attribute) {
      return shaders.attributeLocation(declaration.name);
    }
    else {
      let message = &quot;The mesh does not support attribute &quot; + declaration.type + &quot; &quot; + declaration.name;
      console.warn(message);
      throw new Error(message);
    }
  }
  /**
   * Constructs a ShaderUniformLocation from a declaration.
   */
  function shaderUniformLocationFromDecl(declaration: ShaderVariableDecl): ShaderUniformLocation {
    // By using the ShaderProgram, we get to delegate the management of uniform locations. 
    return shaders.uniformLocation(declaration.name);
  }

  function checkUniformsCompleteAndReady(provider: UniformProvider) {
    var metas = provider.getUniformMetaInfos();
    shaders.uniforms.forEach(function(uniformDecl: ShaderVariableDecl) {
      var match: UniformMetaInfo = void 0;
      for (var id in metas) {
        let candidate: UniformMetaInfo = metas[id];
        if (candidate.name === uniformDecl.name) {
          match = candidate;
        }
      }
      if (match === void 0) {
        let message = &quot;Missing uniform &quot; + uniformDecl.type + &quot; &quot; + uniformDecl.name;
        console.warn(message);
        throw new Error(message);
      }
      else {
        if (match.glslType !== uniformDecl.type) {
          let message = &quot;Mismatch in uniform types &quot; + uniformDecl.name;
          console.warn(message);
          throw new Error(message);
        }
        else {
          // check that the uniform has been initialized.
        }
      }
    });
  }
  var context: WebGLRenderingContext;
  var contextGainId: string;
  var elements: ElementArray = new ElementArray(mesh);
  var vertexAttributes: ShaderAttributeLocation[] = shaders.attributes.map(shaderAttributeLocationFromDecl);
  var uniformVariables: ShaderUniformLocation[] = shaders.uniforms.map(shaderUniformLocationFromDecl);

  function updateGeometry() {
    // Make sure to update the mesh first so that the shaders gets the correct data.
    mesh.update(shaders.attributes);
    vertexAttributes.forEach(function(vertexAttribute: ShaderAttributeLocation) {
      let thing = mesh.getVertexAttributeData(vertexAttribute.name);
      if (thing) {
        vertexAttribute.bufferData(thing.data, thing.usage);
      }
      else {
        // We expect this to be detected long before we get here.
        throw new Error(&quot;mesh implementation claims to support but does not provide data for attribute &quot; + vertexAttribute.name);
      }
    });
    elements.bufferData(mesh);
  }

  var publicAPI = {
    get mesh(): MESH {
      return mesh;
    },
    get shaders(): SHADERS {
      return shaders;
    },
    get model(): MODEL {
      return model;
    },
    contextFree() {
      shaders.contextFree();
      elements.contextFree();
      context = null;
      contextGainId = null;
    },
    contextGain(contextArg: WebGLRenderingContext, contextId: string) {
      context = contextArg;
      if (contextGainId !== contextId) {
        contextGainId = contextId;
        shaders.contextGain(context, contextId);
        elements.contextGain(context, contextId);

        if (!mesh.dynamic) {
          updateGeometry();
        }
      }
    },
    contextLoss() {
      shaders.contextLoss();
      elements.contextLoss();
      context = null;
      contextGainId = null;
    },
    hasContext(): boolean {
      return shaders.hasContext();
    },
    get drawGroupName(): string {return shaders.programId;},
    /**
     * @method useProgram
     */
    useProgram() { return shaders.use(); },
    /**
     * @method draw
     * @param ambients {UniformProvider}
     */
    draw(ambients: UniformProvider) {
      if (shaders.hasContext()) {
        if (mesh.dynamic) {
          updateGeometry();
        }
        let chainedProvider = new ChainedUniformProvider(model, ambients);
        checkUniformsCompleteAndReady(chainedProvider);
        // check we have them all.
        // check they are all initialized.
        // Update the uniform location values.
        uniformVariables.forEach(function(uniformVariable: ShaderUniformLocation) {
          switch(uniformVariable.glslType) {
            case &#x27;float&#x27;: {
              let data: number = chainedProvider.getUniformFloat(uniformVariable.name);
              if (typeof data !== &#x27;undefined&#x27;) {
                if (typeof data === &#x27;number&#x27;) {
                  uniformVariable.uniform1f(data);
                }
                else {
                  throw new Error(&quot;Expecting typeof data for uniform float &quot; + uniformVariable.name + &quot; to be &#x27;number&#x27;.&quot;);
                }
              }
              else {
                throw new Error(&quot;Expecting data for uniform float &quot; + uniformVariable.name);
              }
            }
            break;
            case &#x27;vec2&#x27;: {
              let data: number[] = chainedProvider.getUniformVector2(uniformVariable.name);
              if (data) {
                if (data.length === 2) {
                  uniformVariable.uniform2fv(data);
                }
                else {
                  throw new Error(&quot;Expecting data for uniform vec2 &quot; + uniformVariable.name + &quot; to be number[] with length 2&quot;);
                }
              }
              else {
                throw new Error(&quot;Expecting data for uniform vec2 &quot; + uniformVariable.name);
              }
            }
            break;
            case &#x27;vec3&#x27;: {
              let data: number[] = chainedProvider.getUniformVector3(uniformVariable.name);
              if (data) {
                if (data.length === 3) {
                  uniformVariable.uniform3fv(data);
                }
                else {
                  throw new Error(&quot;Expecting data for uniform &quot; + uniformVariable.name + &quot; to be number[] with length 3&quot;);
                }
              }
              else {
                throw new Error(&quot;Expecting data for uniform &quot; + uniformVariable.name);
              }
            }
            break;
            case &#x27;vec4&#x27;: {
              let data: number[] = chainedProvider.getUniformVector4(uniformVariable.name);
              if (data) {
                if (data.length === 4) {
                  uniformVariable.uniform4fv(data);
                }
                else {
                  throw new Error(&quot;Expecting data for uniform &quot; + uniformVariable.name + &quot; to be number[] with length 4&quot;);
                }
              }
              else {
                throw new Error(&quot;Expecting data for uniform &quot; + uniformVariable.name);
              }
            }
            break;
            case &#x27;mat3&#x27;: {
              let data = chainedProvider.getUniformMatrix3(uniformVariable.name);
              if (data) {
                uniformVariable.uniformMatrix3fv(data.transpose, data.matrix3);
              }
              else {
                throw new Error(&quot;Expecting data for uniform &quot; + uniformVariable.name);
              }
            }
            break;
            case &#x27;mat4&#x27;: {
              let data = chainedProvider.getUniformMatrix4(uniformVariable.name);
              if (data) {
                uniformVariable.uniformMatrix4fv(data.transpose, data.matrix4);
              }
              else {
                throw new Error(&quot;Expecting data for uniform &quot; + uniformVariable.name);
              }
            }
            break;
            default: {
              throw new Error(&quot;Unexpected uniform GLSL type in drawableModel.draw: &quot; + uniformVariable.glslType);
            }
          }
        }); 

        vertexAttributes.forEach(function(vertexAttribute) {
          vertexAttribute.enable();
        });

        vertexAttributes.forEach(function(vertexAttribute: ShaderAttributeLocation) {
          let attribute: AttributeMetaInfo = findAttributeMetaInfoByVariableName(vertexAttribute.name, mesh.getAttributeMetaInfos());
          if (attribute) {
            let size = attribute.size;
            let type = context.FLOAT;//attribute.dataType;
            let normalized = attribute.normalized;
            let stride = attribute.stride;
            let offset = attribute.offset;
            vertexAttribute.dataFormat(size, type, normalized, stride, offset);
          }
          else {
            throw new Error(&quot;The mesh does not support the attribute variable named &quot; + vertexAttribute.name);
          }
        });

        elements.bind();

        mesh.draw(context);

        vertexAttributes.forEach(function(vertexAttribute) {
          vertexAttribute.disable();
        });
      }
    }
  };

  return publicAPI;
};

export = drawableModel;

    </pre>
</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
