<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>src/davinci-eight/programs/shaderProgram.ts - davinci-eight</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="icon" href="../assets/favicon.ico">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
                <h1><img src="../../assets/logo.png" title="davinci-eight"></h1>
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 2.36.0</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
                    <h2 class="off-left">APIs</h2>
                    <div id="api-tabview" class="tabview">
                        <ul class="tabs">
                            <li><a href="#api-classes">Classes</a></li>
                            <li><a href="#api-modules">Modules</a></li>
                        </ul>
                
                        <div id="api-tabview-filter">
                            <input type="search" id="api-filter" placeholder="Type to filter APIs">
                        </div>
                
                        <div id="api-tabview-panel">
                            <ul id="api-classes" class="apis classes">
                                <li><a href="../classes/AmbientLight.html">AmbientLight</a></li>
                                <li><a href="../classes/AttributeMetaInfo.html">AttributeMetaInfo</a></li>
                                <li><a href="../classes/AttributeMetaInfos.html">AttributeMetaInfos</a></li>
                                <li><a href="../classes/AttributeProvider.html">AttributeProvider</a></li>
                                <li><a href="../classes/BoxMesh.html">BoxMesh</a></li>
                                <li><a href="../classes/Cartesian3.html">Cartesian3</a></li>
                                <li><a href="../classes/Color.html">Color</a></li>
                                <li><a href="../classes/Color
                WARNING: In many object-oriented designs, types representing values are completely immutable.
                In a graphics library where data changes rapidly and garbage collection might become an issue,
                it is common to use reference types, such as in this design. This mutability can lead to
                difficult bugs because it is hard to reason about where a color may have changed..html">Color
                WARNING: In many object-oriented designs, types representing values are completely immutable.
                In a graphics library where data changes rapidly and garbage collection might become an issue,
                it is common to use reference types, such as in this design. This mutability can lead to
                difficult bugs because it is hard to reason about where a color may have changed.</a></li>
                                <li><a href="../classes/CuboidMesh.html">CuboidMesh</a></li>
                                <li><a href="../classes/DefaultUniformProvider.html">DefaultUniformProvider</a></li>
                                <li><a href="../classes/DirectionalLight.html">DirectionalLight</a></li>
                                <li><a href="../classes/Drawable.html">Drawable</a></li>
                                <li><a href="../classes/DrawMode.html">DrawMode</a></li>
                                <li><a href="../classes/ElementArray.html">ElementArray</a></li>
                                <li><a href="../classes/EllipsoidMesh.html">EllipsoidMesh</a></li>
                                <li><a href="../classes/Face3.html">Face3</a></li>
                                <li><a href="../classes/Frustum.html">Frustum</a></li>
                                <li><a href="../classes/frustum.html">frustum</a></li>
                                <li><a href="../classes/Geometry.html">Geometry</a></li>
                                <li><a href="../classes/GeometryAdapter.html">GeometryAdapter</a></li>
                                <li><a href="../classes/KleinBottleGeometry.html">KleinBottleGeometry</a></li>
                                <li><a href="../classes/Line3.html">Line3</a></li>
                                <li><a href="../classes/LinearPerspectiveCamera.html">LinearPerspectiveCamera</a></li>
                                <li><a href="../classes/Matrix4
                
                The correspondence between the elements property index and the matrix entries is...
                
                 0  4  8 12
                 1  5  9 13
                 2  6 10 14
                 3  7 11 15.html">Matrix4
                
                The correspondence between the elements property index and the matrix entries is...
                
                 0  4  8 12
                 1  5  9 13
                 2  6 10 14
                 3  7 11 15</a></li>
                                <li><a href="../classes/Model.html">Model</a></li>
                                <li><a href="../classes/ModelMatrixUniformProvider.html">ModelMatrixUniformProvider</a></li>
                                <li><a href="../classes/Mutable.html">Mutable</a></li>
                                <li><a href="../classes/Node3D.html">Node3D</a></li>
                                <li><a href="../classes/perspective.html">perspective</a></li>
                                <li><a href="../classes/Point3.html">Point3</a></li>
                                <li><a href="../classes/PointLight.html">PointLight</a></li>
                                <li><a href="../classes/RenderingContextUser.html">RenderingContextUser</a></li>
                                <li><a href="../classes/ShaderAttributeLocation.html">ShaderAttributeLocation</a></li>
                                <li><a href="../classes/ShaderAttributeLocation..html">ShaderAttributeLocation.</a></li>
                                <li><a href="../classes/ShaderProgram.html">ShaderProgram</a></li>
                                <li><a href="../classes/ShaderUniformLocation.html">ShaderUniformLocation</a></li>
                                <li><a href="../classes/ShaderVariableDecl.html">ShaderVariableDecl</a></li>
                                <li><a href="../classes/Spinor3.html">Spinor3</a></li>
                                <li><a href="../classes/UniformColor.html">UniformColor</a></li>
                                <li><a href="../classes/UniformFloat.html">UniformFloat</a></li>
                                <li><a href="../classes/UniformMetaInfo.html">UniformMetaInfo</a></li>
                                <li><a href="../classes/UniformMetaInfos.html">UniformMetaInfos</a></li>
                                <li><a href="../classes/UniformProvider.html">UniformProvider</a></li>
                                <li><a href="../classes/UniformSpinor3.html">UniformSpinor3</a></li>
                                <li><a href="../classes/UniformVariable.html">UniformVariable</a></li>
                                <li><a href="../classes/UniformVector3.html">UniformVector3</a></li>
                                <li><a href="../classes/Vector3.html">Vector3</a></li>
                                <li><a href="../classes/view.html">view</a></li>
                                <li><a href="../classes/View.html">View</a></li>
                                <li><a href="../classes/Viewport.html">Viewport</a></li>
                                <li><a href="../classes/WindowAnimationRunner.html">WindowAnimationRunner</a></li>
                            </ul>
                
                            <ul id="api-modules" class="apis modules">
                                <li><a href="../modules/EIGHT.html">EIGHT</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
                    Show:
                    <label for="api-show-inherited">
                        <input type="checkbox" id="api-show-inherited" checked>
                        Inherited
                    </label>
            
                    <label for="api-show-protected">
                        <input type="checkbox" id="api-show-protected">
                        Protected
                    </label>
            
                    <label for="api-show-private">
                        <input type="checkbox" id="api-show-private">
                        Private
                    </label>
                    <label for="api-show-deprecated">
                        <input type="checkbox" id="api-show-deprecated">
                        Deprecated
                    </label>
            
                </div>
            
            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
<h1 class="file-heading">File: src/davinci-eight/programs/shaderProgram.ts</h1>

<div class="file">
    <pre class="code prettyprint linenums">
import ShaderProgram = require(&#x27;../programs/ShaderProgram&#x27;);
import AttributeProvider = require(&#x27;../core/AttributeProvider&#x27;);
import parse = require(&#x27;../glsl/parse&#x27;);
import NodeWalker = require(&#x27;../glsl/NodeWalker&#x27;);
import ProgramArgs = require(&#x27;../glsl/ProgramArgs&#x27;);
import Declaration = require(&#x27;../glsl/Declaration&#x27;);
import DebugNodeEventHandler = require(&#x27;../glsl/DebugNodeEventHandler&#x27;);
import DefaultNodeEventHandler = require(&#x27;../glsl/DefaultNodeEventHandler&#x27;);
import uuid4 = require(&#x27;../utils/uuid4&#x27;);
import ShaderAttributeLocation = require(&#x27;../core/ShaderAttributeLocation&#x27;);
import ShaderUniformLocation = require(&#x27;../core/ShaderUniformLocation&#x27;);
import ShaderVariableDecl = require(&#x27;../core/ShaderVariableDecl&#x27;);

var shaderProgram = function(vertexShader: string, fragmentShader: string): ShaderProgram {

  if (typeof vertexShader !== &#x27;string&#x27;) {
    throw new Error(&quot;vertexShader argument must be a string.&quot;);
  }
  if (typeof fragmentShader !== &#x27;string&#x27;) {
    throw new Error(&quot;fragmentShader argument must be a string.&quot;);
  }
  function analyze() {
    // TODO: uniform with same name in both files.
    // TODO: varying correlation.
    function shaderVariable(d: Declaration): ShaderVariableDecl {
      return { modifiers: d.modifiers, type: d.type, name: d.name };
    }
    function analyzeVertexShader() {
      try {
        let vsTree = parse(vertexShader);
        let walker = new NodeWalker();
        let args = new ProgramArgs();
        walker.walk(vsTree, args);
        // attributes
        args.attributes.forEach(function(a: Declaration) {
          let attributeDecl = shaderVariable(a);
          attributeDecls.push(attributeDecl);
          attributeLocations[attributeDecl.name] = new ShaderAttributeLocation(attributeDecl.name, attributeDecl.type);
        });
        // uniforms
        args.uniforms.forEach(function(u: Declaration) {
          let uniformDecl = shaderVariable(u);
          uniformDecls.push(uniformDecl);
          uniformLocations[uniformDecl.name] = new ShaderUniformLocation(uniformDecl.name, uniformDecl.type);
        });
        // varyings
        args.varyings.forEach(function(v: Declaration) {
          let varyingDecl = shaderVariable(v);
          varyingDecls.push(varyingDecl);
        });
      }
      catch(e) {
        console.log(e);
      }
    }
    function analyzeFragmentShader() {
      try {
        let fsTree = parse(fragmentShader);
        let walker = new NodeWalker();
        let args = new ProgramArgs();
        walker.walk(fsTree, args);
        // attributes
        // uniforms
        args.uniforms.forEach(function(u: Declaration) {
          let uniformDecl = shaderVariable(u);
          uniformDecls.push(uniformDecl);
          uniformLocations[uniformDecl.name] = new ShaderUniformLocation(uniformDecl.name, uniformDecl.type);
        });
        // varyings
      }
      catch(e) {
        console.log(e);
      }
    }

    analyzeVertexShader();
    analyzeFragmentShader();
  }

  var program: WebGLProgram;
  var programId: string;
  var context: WebGLRenderingContext;
  var contextGainId: string;

  var attributeDecls: ShaderVariableDecl[] = [];
  var constantDecls:  ShaderVariableDecl[] = [];
  var uniformDecls:   ShaderVariableDecl[] = [];
  var varyingDecls:   ShaderVariableDecl[] = [];

  var attributeLocations: { [name: string]: ShaderAttributeLocation } = {};
  var uniformLocations: { [name: string]: ShaderUniformLocation } = {};

  var publicAPI: ShaderProgram = {
    get vertexShader() {
      return vertexShader;
    },
    get fragmentShader() {
      return fragmentShader;
    },
    get attributes() {
      return attributeDecls;
    },
    get constants() {
      return constantDecls;
    },
    get uniforms() {
      return uniformDecls;
    },
    get varyings() {
      return varyingDecls;
    },
    contextFree: function(): void {
      if (program) {
        context.deleteProgram(program);
        program = void 0;
        programId = void 0;
        context = void 0;
        contextGainId = void 0;
        attributeDecls.forEach(function(attributeDecl) {
          attributeLocations[attributeDecl.name].contextFree();
        });
        uniformDecls.forEach(function(uniformDecl) {
          uniformLocations[uniformDecl.name].contextFree();
        });
      }
    },
    contextGain: function(contextArg: WebGLRenderingContext, contextId: string): void {
      context = contextArg;
      if (contextGainId !== contextId) {
        program = makeWebGLProgram(context, vertexShader, fragmentShader);
        programId = uuid4().generate();
        contextGainId = contextId;
        attributeDecls.forEach(function(attributeDecl) {
          attributeLocations[attributeDecl.name].contextGain(contextArg, program);
        });
        uniformDecls.forEach(function(uniformDecl) {
          uniformLocations[uniformDecl.name].contextGain(contextArg, program);
        });
      }
    },
    contextLoss() {
      program = void 0;
      programId = void 0;
      context = void 0;
      contextGainId = void 0;
      attributeDecls.forEach(function(attributeDecl) {
        attributeLocations[attributeDecl.name].contextLoss();
      });
      uniformDecls.forEach(function(uniformDecl) {
        uniformLocations[uniformDecl.name].contextLoss();
      });
    },
    hasContext: function(): boolean {
      return !!program;
    },
    get program() { return program; },
    get programId() {return programId;},
    use() {
      if (context) {
        return context.useProgram(program);
      }
    },
    attributeLocation(name: string) {
      if (attributeLocations[name]) {
        return attributeLocations[name];
      }
      else {
        throw new Error(name + &quot; is not an attribute variable in the shader program.&quot;);
      }
    },
    uniformLocation(name: string) {
      if (uniformLocations[name]) {
        return uniformLocations[name];
      }
      else {
        throw new Error(name + &quot; is not a uniform variable in the shader program.&quot;);
      }
    }
  };

  analyze();

  return publicAPI;
};

/**
 * Creates a WebGLProgram with compiled and linked shaders.
 */
function makeWebGLProgram(gl: WebGLRenderingContext, vertexShader: string, fragmentShader: string): WebGLProgram {
  // TODO: Proper cleanup if we throw an error at any point.
  var vs = gl.createShader(gl.VERTEX_SHADER);
  gl.shaderSource(vs, vertexShader);
  gl.compileShader(vs);
  if (!gl.getShaderParameter(vs, gl.COMPILE_STATUS)) {
    throw new Error(gl.getShaderInfoLog(vs));
  }
  var fs = gl.createShader(gl.FRAGMENT_SHADER);
  gl.shaderSource(fs, fragmentShader);
  gl.compileShader(fs);
  if (!gl.getShaderParameter(fs, gl.COMPILE_STATUS)) {
    throw new Error(gl.getShaderInfoLog(fs));
  }
  var program = gl.createProgram();
  gl.attachShader(program, vs);
  gl.attachShader(program, fs);
  gl.linkProgram(program);
  if (!gl.getProgramParameter(program, gl.LINK_STATUS)) {
    throw new Error(gl.getProgramInfoLog(program));
  }
  return program;
}

export = shaderProgram;
    </pre>
</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
