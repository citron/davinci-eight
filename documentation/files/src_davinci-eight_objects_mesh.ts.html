<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>src/davinci-eight/objects/mesh.ts - davinci-eight</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="icon" href="../assets/favicon.ico">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
                <h1><img src="../../assets/logo.png" title="davinci-eight"></h1>
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 2.18.0</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
                    <h2 class="off-left">APIs</h2>
                    <div id="api-tabview" class="tabview">
                        <ul class="tabs">
                            <li><a href="#api-classes">Classes</a></li>
                            <li><a href="#api-modules">Modules</a></li>
                        </ul>
                
                        <div id="api-tabview-filter">
                            <input type="search" id="api-filter" placeholder="Type to filter APIs">
                        </div>
                
                        <div id="api-tabview-panel">
                            <ul id="api-classes" class="apis classes">
                                <li><a href="../classes/camera.html">camera</a></li>
                                <li><a href="../classes/Geometry.html">Geometry</a></li>
                                <li><a href="../classes/KleinBottleGeometry.html">KleinBottleGeometry</a></li>
                                <li><a href="../classes/Object3D.html">Object3D</a></li>
                                <li><a href="../classes/PerspectiveCamera.html">PerspectiveCamera</a></li>
                                <li><a href="../classes/Scene.html">Scene</a></li>
                                <li><a href="../classes/Spinor3.html">Spinor3</a></li>
                                <li><a href="../classes/Vector3.html">Vector3</a></li>
                                <li><a href="../classes/VertexAttributeProvider.html">VertexAttributeProvider</a></li>
                                <li><a href="../classes/WebGLRenderer.html">WebGLRenderer</a></li>
                            </ul>
                
                            <ul id="api-modules" class="apis modules">
                                <li><a href="../modules/EIGHT.html">EIGHT</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
                    Show:
                    <label for="api-show-inherited">
                        <input type="checkbox" id="api-show-inherited" checked>
                        Inherited
                    </label>
            
                    <label for="api-show-protected">
                        <input type="checkbox" id="api-show-protected">
                        Protected
                    </label>
            
                    <label for="api-show-private">
                        <input type="checkbox" id="api-show-private">
                        Private
                    </label>
                    <label for="api-show-deprecated">
                        <input type="checkbox" id="api-show-deprecated">
                        Deprecated
                    </label>
            
                </div>
            
            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
<h1 class="file-heading">File: src/davinci-eight/objects/mesh.ts</h1>

<div class="file">
    <pre class="code prettyprint linenums">
/// &lt;reference path=&quot;../geometries/VertexAttributeProvider.d.ts&quot; /&gt;
/// &lt;reference path=&quot;../materials/Material.d.ts&quot; /&gt;
/// &lt;reference path=&quot;../renderers/VertexUniformProvider.d.ts&quot; /&gt;
import ShaderAttributeVariable = require(&#x27;./ShaderAttributeVariable&#x27;);
import object3D = require(&#x27;davinci-eight/core/functionalConstructorObject3D&#x27;);
import vs_source = require(&#x27;davinci-eight/shaders/shader-vs&#x27;);
import fs_source = require(&#x27;davinci-eight/shaders/shader-fs&#x27;);
import glMatrix = require(&#x27;gl-matrix&#x27;);
import ElementArray = require(&#x27;davinci-eight/objects/ElementArray&#x27;);
import ShaderUniformVariable = require(&#x27;davinci-eight/objects/ShaderUniformVariable&#x27;);
import ChainedVertexUniformProvider = require(&#x27;./ChainedVertexUniformProvider&#x27;);
import FactoredDrawable = require(&#x27;../objects/FactoredDrawable&#x27;);
import Vector3 = require(&#x27;../math/Vector3&#x27;);
import Spinor3 = require(&#x27;../math/Spinor3&#x27;);

var mesh = function&lt;G extends VertexAttributeProvider, M extends Material&gt;(
  geometry: G,
  material: M,
  meshUniforms: VertexUniformProvider): FactoredDrawable&lt;G, M&gt; {
  /**
   * Find an attribute by its code name rather than its semantic role (which is the key in AttributeMetaInfos)
   */
  function findAttributeByVariableName(name: string, attributes: AttributeMetaInfos): AttributeMetaInfo {
    for (var key in attributes) {
      let attribute = attributes[key];
      if (attribute.name === name) {
        return attribute;
      }
    }
  }
  /**
   * Constructs a ShaderAttributeVariable from a declaration.
   */
  function vertexAttrib(declaration: {modifiers: string[], type: string, name: string}): ShaderAttributeVariable {
    let name = declaration.name;
    let attribute: AttributeMetaInfo = findAttributeByVariableName(name, geometry.getAttributeMetaInfos());
    if (attribute) {
      let size = attribute.size;
      let normalized = attribute.normalized;
      let stride = attribute.stride;
      let offset = attribute.offset;
      // TODO: Maybe type should be passed along?
      return new ShaderAttributeVariable(name, size, normalized, stride, offset);
    }
    else {
      throw new Error(&quot;The geometry does not support the attribute variable named &quot; + name);
    }
  }

  /**
   * Constructs a ShaderUniformVariable from a declaration.
   */
  function shaderUniformFromDecl(declaration: {modifiers: string[], type: string, name: string}): ShaderUniformVariable {
    var modifiers = declaration.modifiers;
    var type = declaration.type;
    var name = declaration.name;
    return new ShaderUniformVariable(name, type);
  }

  var base = object3D();
  var contextGainId: string;
  var elements = new ElementArray(geometry);
  var vertexAttributes: ShaderAttributeVariable[] = material.attributes.map(vertexAttrib);
  var uniformVariables: ShaderUniformVariable[] = material.uniforms.map(shaderUniformFromDecl);
  if (uniformVariables.length &gt; 0) {
    if (typeof meshUniforms === &#x27;undefined&#x27;) {
      throw new Error(&#x27;meshUniforms argument must be supplied for shader uniform variables.&#x27;);
    }
    else {
      if (typeof meshUniforms !== &#x27;object&#x27;) {
        throw new Error(&#x27;meshUniforms must be an object.&#x27;);
      }
    }
  }

  function updateGeometry(context: WebGLRenderingContext, time: number) {
    // Make sure to update the geometry first so that the material gets the correct data.
    geometry.update(time, material.attributes);
    vertexAttributes.forEach(function(vertexAttribute) {
      vertexAttribute.bufferData(context, geometry);
    });
    elements.bufferData(context, geometry);
  }

  var publicAPI = {
    get geometry(): G {
      return geometry;
    },
    get material(): M {
      return material;
    },
    contextFree(context: WebGLRenderingContext) {
      material.contextFree(context);
      vertexAttributes.forEach(function(vertexAttribute) {
        vertexAttribute.contextFree(context);
      });
      elements.contextFree(context);
    },
    contextGain(context: WebGLRenderingContext, contextId: string) {
      if (contextGainId !== contextId) {
        contextGainId = contextId;
        material.contextGain(context, contextId);

        // Cache the attribute variable locations.
        vertexAttributes.forEach(function(vertexAttribute) {
          vertexAttribute.contextGain(context, material.program);
        });

        elements.contextGain(context);

        // TODO: This should really be consulting a needsUpdate method.
        // We can also put the updates inside the vertexAttribute loop.
        if (!geometry.dynamics()) {
          updateGeometry(context, 0);
        }

        // Cache the uniform variable locations.
        uniformVariables.forEach(function(uniformVariable) {
          uniformVariable.contextGain(context, material.program);
        }); 
      }
    },
    contextLoss() {
      material.contextLoss();
      vertexAttributes.forEach(function(vertexAttribute) {
        vertexAttribute.contextLoss();
      });
      elements.contextLoss();
    },
    hasContext(): boolean {
      return material.hasContext();
    },
    get drawGroupName(): string {return material.programId;},
    useProgram(context: WebGLRenderingContext) {
      context.useProgram(material.program);
    },
    draw(context: WebGLRenderingContext, time: number, ambientUniforms: VertexUniformProvider) {
      if (material.hasContext()) {
        // TODO: This should be a needs update.
        if (geometry.dynamics()) {
          updateGeometry(context, time);
        }
        // Update the uniform location values.
        uniformVariables.forEach(function(uniformVariable: ShaderUniformVariable) {
          if (meshUniforms) {
            var chainedProvider = new ChainedVertexUniformProvider(meshUniforms, ambientUniforms);
            switch(uniformVariable.type) {
              case &#x27;mat3&#x27;: {
                var m3data = chainedProvider.getUniformMatrix3(uniformVariable.name);
                if (m3data) {
                  uniformVariable.matrix(context, m3data.transpose, m3data.matrix3);
                }
                else {
                  throw new Error(&quot;Expecting data from mesh callback for uniform &quot; + uniformVariable.name);
                }
              }
              break;
              case &#x27;mat4&#x27;: {
                var m4data = chainedProvider.getUniformMatrix4(uniformVariable.name);
                if (m4data) {
                  uniformVariable.matrix(context, m4data.transpose, m4data.matrix4);
                }
                else {
                  throw new Error(&quot;Expecting data from mesh callback for uniform &quot; + uniformVariable.name);
                }
              }
              break;
              default: {
                throw new Error(&quot;uniform type =&gt; &quot; + uniformVariable.type);
              }
            }
          }
          else {
            // Backstop in case it&#x27;s not being checked in construction
            throw new Error(&quot;callback not supplied&quot;);
          }
        }); 

        vertexAttributes.forEach(function(vertexAttribute) {
          vertexAttribute.enable(context);
        });

        vertexAttributes.forEach(function(vertexAttribute) {
          vertexAttribute.bind(context);
        });

        geometry.draw(context);
        elements.bind(context);

        vertexAttributes.forEach(function(vertexAttribute) {
          vertexAttribute.disable(context);
        });
      }
    },
    get position(): Vector3 {return base.position },
    set position(position: Vector3) { base.position = position },
    get attitude(): Spinor3 {return base.attitude },
    set attitude(attitude: Spinor3) { base.attitude = attitude }
  };

  return publicAPI;
};

export = mesh;

    </pre>
</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
